esphome:
  name: pico-display
  friendly_name: pico-display

rp2040:
  board: rpipicow

# Enable logging
logger:

# Enable Home Assistant API
api:
  encryption:
    key: ""

ota:
  - platform: esphome
    password: ""
  
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password

light:
  - platform: status_led
    name: "Status LED"
    pin: GPIO32

binary_sensor:
  - platform: status
    name: "Node Status"
    id: system_status
    icon: mdi:lan-connect
    
spi:
  clk_pin: GPIO10
  mosi_pin: GPIO11

display:
  - platform: ssd1306_spi
    model: "SSD1305 128x32"
    cs_pin: GPIO9
    dc_pin: GPIO8
    offset_x: 4
    id: my_display
    pages:
      - id: page1
        lambda: |-
          if (id(nearest_flight_number).has_state()) {
            id(my_display).turn_on();

            it.image(0, 0, id(plane_img));
            it.print(15, 0, id(my_font), id(nearest_flight_number).state.c_str());
            it.print(0, 10, id(my_font), id(airport_od).state.c_str());
            it.print(0, 20, id(my_font), id(nearest_flight_model).state.c_str());

          } else {
            id(my_display).turn_off();
          }
     
# Optional: Custom font
font:
  - file: "gfonts://Barlow"
    id: my_font
    size: 10

# --- SENSORS ---

text_sensor:
  # Sensor to hold the final parsed flight number
  - platform: template
    id: nearest_flight_number
    name: "Nearest Flight Number"
    icon: "mdi:airplane"
    internal: True
  - platform: template
    id: nearest_flight_model
    name: "Nearest Flight Model"
    icon: "mdi:arrow-up-down"
    internal: True
  - platform: template
    id: airport_od
    name: "Airport Origin & Destination"
    internal: True
  - platform: template
    id: airline_short
    name: "Airline"
    internal: True  
  # Sensor to import the raw 'flights' attribute from Home Assistant
  - platform: homeassistant
    entity_id: sensor.flightradar24_current_in_area
    attribute: flights
    id: fr24_flights_json_string
    internal: true # Hide this raw data sensor from HA
    
    on_value:
          then:
            - lambda: |-
                std::string raw_string = x;
                
                // Define the helper function to extract a value based on a key.
                // This function is designed to handle the Python-style format ('key': 'value')
                auto extract_value = [&](const std::string& key) -> std::string {
                    size_t start_pos = raw_string.find(key);
                    if (start_pos == std::string::npos) return "";

                    // Move past the key, colon, and opening quote: e.g., 'flight_number': '
                    start_pos = raw_string.find("': '", start_pos);
                    if (start_pos == std::string::npos) return "";
                    start_pos += 4; // Move 4 chars past "': '"

                    // Find the closing quote of the value
                    size_t end_pos = raw_string.find('\'', start_pos);
                    if (end_pos == std::string::npos) return "";

                    return raw_string.substr(start_pos, end_pos - start_pos);
                };

                // Check if any flights were found (very basic check)
                if (raw_string.length() < 10) { 
                    id(nearest_flight_number).publish_state("N/A");
                    id(nearest_flight_model).publish_state(0);
                    ESP_LOGI("parser", "No flights found or string too short.");
                    return;
                }

                // --- Extraction ---
                std::string flight_num = extract_value("'flight_number'");
                std::string model_str = extract_value("'aircraft_model'");
                std::string airport_origin_str = extract_value("'airport_origin_city'");
                std::string airport_destination_str = extract_value("'airport_destination_city'");
                std::string airline_str = extract_value("'airline_short'");
                // --- Publishing Results ---

                // Flight Number
                if (!flight_num.empty()) {
                    id(nearest_flight_number).publish_state(airline_str + " " + flight_num);
                    id(airport_od).publish_state(airport_origin_str + " -> " + airport_destination_str);
                } else {
                    id(nearest_flight_number).publish_state("No F#");
                }
                
                // model
                if (!model_str.empty()) {
                    id(nearest_flight_model).publish_state(model_str);
                } else {
                    id(nearest_flight_model).publish_state(0);
                }

image:
  defaults:
    type: BINARY
    resize: 10x10
    transparency: chroma_key    
  images:
    - file: mdi:airplane
      id: plane_img

