esphome:
  name: pico-display
  friendly_name: pico-display

rp2040:
  board: rpipicow

# Enable logging
logger:
  level: INFO
# Enable Home Assistant API
api:
  encryption:
    key: ""

ota:
  - platform: esphome
    password: ""
  
wifi:
  ssid: !secret wifi_ssid
  password: !secret wifi_password
  power_save_mode: NONE

mdns:

status_led:
  pin:
    number: GPIO32

spi:
  clk_pin: GPIO10
  mosi_pin: GPIO11

display:
  - platform: ssd1306_spi
    model: "SSD1305 128x32"
    cs_pin: GPIO9
    dc_pin: GPIO8
    #reset_pin: GPI012
    offset_x: 4
    id: my_display
    pages:
      - id: page1
        lambda: |-
          // --- Flight Number ---
          if (id(planes_nearby).state ) {
            id(my_display).turn_on();
            it.image(0, 0, id(plane_img));
            it.print(15, 0, id(my_font), id(line_1).state.c_str());
            it.print(0, 10, id(my_font), id(airport_od).state.c_str());
            it.print(0, 20, id(my_font), id(flight_model).state.c_str());

          } else {
            id(my_display).turn_off();
          }
     
# Optional: Custom font
font:
  - file: "gfonts://Doto"
    id: my_font
    size: 10

# --- SENSORS ---
text_sensor:
  - platform: homeassistant
    entity_id: sensor.closest_flight_callsign
    id: flight_callsign
    name: "Nearest Flight Callsign"
    internal: True
    on_value: 
      then:
        - component.update: line_1

  - platform: homeassistant
    entity_id: sensor.closest_flight_aircraft
    id: flight_model
    name: "Nearest Flight Model"
    internal: True

  - platform: homeassistant
    entity_id: sensor.closest_flight_origin
    id: airport_origin
    name: "Airport Origin"
    internal: True
    on_value: 
      then:
        - component.update: airport_od

  - platform: homeassistant
    entity_id: sensor.closest_flight_destination
    id: airport_destination
    name: "Airport Destination"
    internal: True
    on_value: 
      then:
        - component.update: airport_od

  - platform: homeassistant
    entity_id: sensor.closest_flight_airline
    id: airline
    name: "Airline"
    internal: True
    on_value: 
      then:
        - component.update: line_1
  
  - platform: template
    id: line_1
    name: "Display Line 1"
    internal: True
    lambda: |-
          std::string s1 = id(airline).state;
          std::string s2 = id(flight_callsign).state;

          if (s1.empty() || s1 == "None" || s1 == "unavailable" || s1 == "unknown"){
            // If no airline, return the callsign.
            if (s2.empty() || s2 == "None" || s2 == "unavailable" || s2 == "unknown"){
              return {};
            } else {
              return s2;
            }
          } else {
            // Return the airline
            return s1;
          }

  - platform: template
    id: airport_od
    name: "Combined Airport Origin & Destination"
    internal: True
    lambda: |-
          // Access the states of the imported sensors
          std::string s1 = id(airport_origin).state;
          std::string s2 = id(airport_destination).state;

          if (s2.empty() || s2 == "None" || s2 == "unavailable" || s2 == "unknown"){
            // If there's no destination, don't bother joining the strings.
            return s1;
          } else {
            // Concatenate them with a separator
            return s1 + " > " + s2;
          }
binary_sensor:
  - platform: homeassistant
    entity_id: binary_sensor.planes_nearby
    id: planes_nearby
    internal: True
    on_state: 
      then:
        - component.update: airport_od
        - component.update: line_1
        - component.update: my_display  # This is probaby very unnecessary

  - platform: status
    name: "Node Status"
    id: system_status
    icon: mdi:lan-connect
image:
  defaults:
    type: BINARY
    resize: 10x10
    #transparency: chroma_key    
  images:
    - file: mdi:airplane
      id: plane_img

# ---------------------------------------------------------------------
# This version puts the parsing back on Home Assistant using helpers.  
# The various helpers need to be added, but the code is here:
# ---------------------------------------------------------------------
# 
# helper:  Closest Flight Aircraft
# type:  Template Sensor  
#            {% set flights = state_attr('sensor.flightradar24_current_in_area', 'flights') %}
#            {% if flights %}
#              {{ (flights | sort(attribute='distance'))[0].aircraft_model }}
#            {% else %}
#              None
#            {% endif %} 
#
#
#helper: Closest Flight Airline
#type: Template Sensor
#            {% set flights = state_attr('sensor.flightradar24_current_in_area', 'flights') %}
#            {% if flights %}
#              {{ (flights | sort(attribute='distance'))[0].airline_short }}
#            {% else %}
#              None
#            {% endif %}
#helper: Closest Flight Callsign
#type: Template Sensor
#          {% set flights = state_attr('sensor.flightradar24_current_in_area', 'flights') %}
#          {% if flights %}
#            {{ (flights | sort(attribute='distance'))[0].flight_number | default((flights | sort(attribute='distance'))[0].callsign) }}
#          {% else %}
#            No Flight
#          {% endif %}
#helper: Closest Flight Origin
#type: Template Sensor
#            {% set flights = state_attr('sensor.flightradar24_current_in_area', 'flights') %}
#            {% if flights %}
#              {{ (flights | sort(attribute='distance'))[0].airport_origin_city }}
#            {% else %}
#              None
#            {% endif %}
#helper: Closest Flight Destination
#type: Template Sensor
#            {% set flights = state_attr('sensor.flightradar24_current_in_area', 'flights') %}
#            {% if flights %}
#              {{ (flights | sort(attribute='distance'))[0].airport_destination_city }}
#            {% else %}
#              None
#            {% endif %}
#helper: Planes Nearby
#type: Template Binary Sensor
#            {{ states('sensor.flightradar24_current_in_area') | int(0) > 0 }}
